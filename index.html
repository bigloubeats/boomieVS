<script>
    const BRIDGE_URL = 'https://boomie-bridge.nullsetdesign.workers.dev/';
    const ALARM_SOUND = new Audio('airhorn.mp3'); 
    let timerInterval = null;

    // Helper to format seconds into 0:00 style
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    async function hit(command) {
        const statusEl = document.getElementById('status');
        if (!timerInterval) {
            statusEl.innerText = "SENDING...";
            statusEl.style.color = "white";
        }

        try {
            const response = await fetch(`${BRIDGE_URL}?cmd=${encodeURIComponent(command)}`);
            if (response.ok && !timerInterval) {
                statusEl.innerText = "SENT: " + command;
                statusEl.style.color = "#4ade80";
            }
        } catch (err) {
            statusEl.innerText = "CONNECTION FAILED";
            statusEl.style.color = "#f87171";
        }

        if (!timerInterval) {
            setTimeout(() => {
                statusEl.innerText = "BRIDGE READY";
                statusEl.style.color = "#888";
            }, 2000);
        }
    }

    // Fixed to 300 seconds (5 minutes)
    function startWithTimer() {
        hit('!startgame'); 
        runTimer(300); 
    }

    function runTimer(duration) {
        const statusEl = document.getElementById('status');
        let timeLeft = duration;

        clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            timeLeft--;
            statusEl.innerText = `GAME TIME: ${formatTime(timeLeft)}`;
            statusEl.style.color = "#4ade80";

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                statusEl.innerText = "TIME'S UP!";
                statusEl.style.color = "#f87171";
                
                ALARM_SOUND.play().catch(e => console.log("Audio play failed:", e));
                
                setTimeout(() => {
                    statusEl.innerText = "BRIDGE READY";
                    statusEl.style.color = "#888";
                }, 5000);
            }
        }, 1000);
    }

    window.hit = hit;
    window.startWithTimer = startWithTimer;
</script>

